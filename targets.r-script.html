<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>B.3 _targets.R script | Air-Health SWS R targets (Last edited on 2022-04-02)</title>
  <meta name="description" content="B.3 _targets.R script | Air-Health SWS R targets (Last edited on 2022-04-02)" />
  <meta name="generator" content="bookdown 0.25 and GitBook 2.6.7" />

  <meta property="og:title" content="B.3 _targets.R script | Air-Health SWS R targets (Last edited on 2022-04-02)" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="B.3 _targets.R script | Air-Health SWS R targets (Last edited on 2022-04-02)" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="directory-and-file-structure.html"/>
<link rel="next" href="metaprogramming.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction<span></span></a></li>
<li class="chapter" data-level="2" data-path="health-impact-function.html"><a href="health-impact-function.html"><i class="fa fa-check"></i><b>2</b> Health impact function<span></span></a>
<ul>
<li class="chapter" data-level="2.1" data-path="epidemiological-study-designs-source-sample-and-study-populations.html"><a href="epidemiological-study-designs-source-sample-and-study-populations.html"><i class="fa fa-check"></i><b>2.1</b> Epidemiological study designs: source, sample and study populations<span></span></a></li>
<li class="chapter" data-level="2.2" data-path="case-definition.html"><a href="case-definition.html"><i class="fa fa-check"></i><b>2.2</b> Case definition<span></span></a></li>
<li class="chapter" data-level="2.3" data-path="relative-risk-odds-ratio-and-hazard-ratio.html"><a href="relative-risk-odds-ratio-and-hazard-ratio.html"><i class="fa fa-check"></i><b>2.3</b> Relative risk, odds ratio and hazard ratio<span></span></a></li>
<li class="chapter" data-level="2.4" data-path="the-paf-population-attributable-fraction.html"><a href="the-paf-population-attributable-fraction.html"><i class="fa fa-check"></i><b>2.4</b> The PAF (population attributable fraction)<span></span></a></li>
<li class="chapter" data-level="2.5" data-path="tmrel.html"><a href="tmrel.html"><i class="fa fa-check"></i><b>2.5</b> TMREL<span></span></a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="study-population-and-health-outcomes.html"><a href="study-population-and-health-outcomes.html"><i class="fa fa-check"></i><b>3</b> Study population and health outcomes<span></span></a>
<ul>
<li class="chapter" data-level="3.1" data-path="source-sample-and-study-population.html"><a href="source-sample-and-study-population.html"><i class="fa fa-check"></i><b>3.1</b> Source, sample and study population<span></span></a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="exposure-assessment.html"><a href="exposure-assessment.html"><i class="fa fa-check"></i><b>4</b> Exposure assessment<span></span></a>
<ul>
<li class="chapter" data-level="4.1" data-path="spatial-modelling-and-dealing-with-coverage-issues-or-missingness.html"><a href="spatial-modelling-and-dealing-with-coverage-issues-or-missingness.html"><i class="fa fa-check"></i><b>4.1</b> Spatial modelling and dealing with coverage issues or missingness<span></span></a></li>
<li class="chapter" data-level="4.2" data-path="counterfactual.html"><a href="counterfactual.html"><i class="fa fa-check"></i><b>4.2</b> Counterfactual<span></span></a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="link-population-health-and-environment-data.html"><a href="link-population-health-and-environment-data.html"><i class="fa fa-check"></i><b>5</b> Link population, health and environment data<span></span></a>
<ul>
<li class="chapter" data-level="5.1" data-path="spatial-and-temporal-issues.html"><a href="spatial-and-temporal-issues.html"><i class="fa fa-check"></i><b>5.1</b> Spatial and temporal issues<span></span></a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="attributable-number.html"><a href="attributable-number.html"><i class="fa fa-check"></i><b>6</b> Attributable number<span></span></a>
<ul>
<li class="chapter" data-level="6.1" data-path="life-tables.html"><a href="life-tables.html"><i class="fa fa-check"></i><b>6.1</b> Life tables<span></span></a></li>
</ul></li>
<li class="appendix"><span><b>Appendix<span></span></b></span></li>
<li class="chapter" data-level="A" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>A</b> Getting started<span></span></a></li>
<li class="chapter" data-level="B" data-path="code-overview.html"><a href="code-overview.html"><i class="fa fa-check"></i><b>B</b> Code overview<span></span></a>
<ul>
<li class="chapter" data-level="B.1" data-path="r-targets-package.html"><a href="r-targets-package.html"><i class="fa fa-check"></i><b>B.1</b> R targets package<span></span></a>
<ul>
<li class="chapter" data-level="B.1.1" data-path="r-targets-package.html"><a href="r-targets-package.html#function-oriented-programming"><i class="fa fa-check"></i><b>B.1.1</b> Function-oriented programming<span></span></a></li>
</ul></li>
<li class="chapter" data-level="B.2" data-path="directory-and-file-structure.html"><a href="directory-and-file-structure.html"><i class="fa fa-check"></i><b>B.2</b> Directory and File Structure<span></span></a></li>
<li class="chapter" data-level="B.3" data-path="targets.r-script.html"><a href="targets.r-script.html"><i class="fa fa-check"></i><b>B.3</b> _targets.R script<span></span></a>
<ul>
<li class="chapter" data-level="B.3.1" data-path="targets.r-script.html"><a href="targets.r-script.html#input-targets"><i class="fa fa-check"></i><b>B.3.1</b> input targets<span></span></a></li>
<li class="chapter" data-level="B.3.2" data-path="targets.r-script.html"><a href="targets.r-script.html#data-targets"><i class="fa fa-check"></i><b>B.3.2</b> data targets<span></span></a></li>
<li class="chapter" data-level="B.3.3" data-path="targets.r-script.html"><a href="targets.r-script.html#analysis-targets"><i class="fa fa-check"></i><b>B.3.3</b> analysis targets<span></span></a></li>
<li class="chapter" data-level="B.3.4" data-path="targets.r-script.html"><a href="targets.r-script.html#viz-targets"><i class="fa fa-check"></i><b>B.3.4</b> viz targets<span></span></a></li>
<li class="chapter" data-level="B.3.5" data-path="targets.r-script.html"><a href="targets.r-script.html#pipeline-list"><i class="fa fa-check"></i><b>B.3.5</b> Pipeline list<span></span></a></li>
</ul></li>
<li class="chapter" data-level="B.4" data-path="metaprogramming.html"><a href="metaprogramming.html"><i class="fa fa-check"></i><b>B.4</b> Metaprogramming<span></span></a></li>
</ul></li>
<li class="chapter" data-level="C" data-path="case-study---who-guidelines.html"><a href="case-study---who-guidelines.html"><i class="fa fa-check"></i><b>C</b> Case Study - WHO guidelines<span></span></a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Air-Health SWS R targets (Last edited on 2022-04-02)</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="targets.r-script" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">B.3</span> _targets.R script<a href="targets.r-script.html#targets.r-script" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As is standard with any _targets.R script, the structure is as follows:</p>
<ul>
<li>Load targets library (and tarchetypes if using)</li>
<li>Source custom functions</li>
<li>Set global variables</li>
<li>Set target options (set what R packages are to be available to the pipeline)</li>
<li>Define targets</li>
</ul>
<p>Custom functions used in the pipeline are loaded from the <code>R/</code> folder. Though one can define the functions within <code>_targets.R</code>, keeping functions separately helps to keep code tidy. Additionally, the function files can be sourced or copied as needed for other projects.</p>
<p>Global variables, here <code>state</code> and <code>year</code>, are a tidier way to specify parameters that are repeatedly used. In this case, the state and/or year are passed into various import data functions to indicate which subset of available data to use. The boolean <code>download_data</code>, to indicate whether to retrieve data from Cloudstor using the <a href="https://github.com/pdparker/cloudstoR">cloudstoR library</a>, and data paths are also specified as global variables for ease of modification.</p>
<p>Packages specified in <code>tar_option_set</code> are globally available to subsequent targets. If a target fails because a function cannot be found, double-check the required package is listed here.</p>
<p>Finally, targets are defined in a list. For legibility, targets are divided into four lists, assigned to variables <code>input</code>, <code>data</code>, <code>analysis</code> and <code>viz</code>. These are then combined in the final list that defines the pipeline. Each of the target divisions has a corresponding function folder.</p>
<pre><code>input ....... R/import_data
data ........ R/func_data
analysis .... R/func_analysis
viz ......... R/func_viz</code></pre>
<p>It is, of course, not necessary to use this organisation of targets and function files. All targets can be directly defined within the pipeline list and all function files can be stored under <code>R/</code>, or some alternative arrangement is possible.</p>
<div id="input-targets" class="section level3 hasAnchor" number="8.3.1">
<h3><span class="header-section-number">B.3.1</span> input targets<a href="targets.r-script.html#input-targets" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Each element in the <code>input</code> list is the result of calling a function to import and tidy a specific dataset. Unlike the subsequent target lists <code>data</code>, <code>analysis</code>, and <code>viz</code> where an element defines one target, the functions called in <code>input</code> generate a series of targets. The series of targets tracks the data file(s), reads and tidies the data. Since each data has its own formats and quirks, the tidying process is unique to each and thus the code block is defined in the command argument of the target rather than as a separate function. (See any one of the functions under <code>R/import_data</code>.)</p>
<p>Note that some of the import functions use <code>tar_target_raw</code> to include outside parameters such as the state or year.</p>
<p>Datasets are not combined or dependent on one another at this stage. Data is manipulated into a tidy format (e.g.Â standardised names, converting column data types, converting to long format), and may be subsetted to relevant columns if the dataset is large.</p>
<p>Further processing of data, such as calculation, combination and extraction takes place in <code>data</code> list.</p>
</div>
<div id="data-targets" class="section level3 hasAnchor" number="8.3.2">
<h3><span class="header-section-number">B.3.2</span> data targets<a href="targets.r-script.html#data-targets" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The separate tidied datasets are combined and processed to a stage where the data is ready to be passed to an analysis function. In this pipeline, this covers the extraction of environmental exposure (from source rasters), calculation of counterfactual exposure, calculation of mortality rate in the impact population, application of mortality rate to the study population and aggregation of population-weighted exposure to study population regions.</p>
<p>The end result of this section of targets is a data table of the study population with expected deaths (from application of mortality data) and exposure in baseline and counterfactual cases (from exposure rasters and defined counterfactual value).</p>
<p>It is not necessary to gather all data into a single table, but avoids redundancy if you have several analysis targets working on the same data - you will not have to combine the data at the start of every analysis target.</p>
<p>As a sidenote, it may be observed that some datasets are split over multiple files, for instance, the ABS meshblock files are by state. Depending on the dataset, tidying and processing may be best done file by file. This is possible through dynamic branching, where target B iterates over the output of other target(s) as defined by the <code>pattern</code> argument. Such dynamically-branched targets appear as a square with <code>tar_glimpse</code> or <code>tar_visnetwork</code>. (Read more at the <a href="https://books.ropensci.org/targets/dynamic.html">targets manual</a>)</p>
<p>Consider the raster extraction to polygon step, one of the more time-consuming steps, where the inputs are exposure rasters (one file = one year) and ABS meshblock polygons (one file = one state). All the exposure rasters share the same projection, extent and resolution and thus can be stacked into a multi-layer raster - extracting a multi-layer raster does not cost much more than extracting from a single-layer raster. On the other hand, the cost of extraction is heavily dependent on the number and complexity of polygons. If an extra state were to be added to the pipeline, it would minimise cost to process and extract each set of state meshblocks separately via dynamic branching. Consequently, dynamic branching is used only on the ABS meshblocks dataset and not the exposure rasters, and branches recombined only after the extraction process is complete.</p>
</div>
<div id="analysis-targets" class="section level3 hasAnchor" number="8.3.3">
<h3><span class="header-section-number">B.3.3</span> analysis targets<a href="targets.r-script.html#analysis-targets" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>After data processing, analysis is performed through two targets - one defining the health impact response and the other applying the response to the processed data to calculate the attributable number of deaths. Further targets can be added to determine other health measures such as years of life lost.</p>
</div>
<div id="viz-targets" class="section level3 hasAnchor" number="8.3.4">
<h3><span class="header-section-number">B.3.4</span> viz targets<a href="targets.r-script.html#viz-targets" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Naturally the results of analysis should be visualised in some form, at the very least for common-sense check. A target can be defined to produce a plot, or, if using <code>tarchetypes</code>, render an R Markdown report which can draw on output of other targets in its content.</p>
<p>In the targets <code>viz_an</code> and <code>leaflet_an</code>, the code block no longer consists of a single function call. Instead, it is a series of data manipulation statements, aggregating and merging with spatial data, before calling the custom plot function. This structure keeps the plot function generalisable rather than specific to the data inputs. The data manipulation code can also be split off into a separation function or even a separate target if the results will be used in multiple targets.</p>
<p>The R Markdown report is rendered in a target by specifying the appropriate <code>.Rmd</code> file in the <code>tarchetypes::tar_render</code> function. To minimise computation time and take advantage of the targets pipeline features, minimal processing should occur in R Markdown code. Target outputs are retrieved with <code>tar_read</code> or <code>tar_load</code>, Read more in the <a href="https://books.ropensci.org/targets/markdown.html#rendering-within-a-target">R targets manual - Literate Programming</a>.</p>
</div>
<div id="pipeline-list" class="section level3 hasAnchor" number="8.3.5">
<h3><span class="header-section-number">B.3.5</span> Pipeline list<a href="targets.r-script.html#pipeline-list" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>_targets.R</code> script must end with a list of targets defining the pipeline, hence all targets previously defined are included as nested lists in this final list.</p>
<p>One more target is introduced here to ensure the existence of the data path (if not downloading data) or valid authentication of Cloudstor access (if downloading data). It is set to run first with the argument <code>priority = 1</code>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="directory-and-file-structure.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="metaprogramming.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
